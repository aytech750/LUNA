<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Luna - Sign Up</title>
  <link rel="stylesheet" href="signup.css"/>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"/>
</head>
<body class="signup-body">
  <div class="form-container">
    <img src="https://i.imgur.com/8KlT8jJ.png" alt="Luna Logo" class="logo" />
    <h1>Create Your Luna Account</h1>
    <form id="signupForm">
      <input type="text" id="name" placeholder="Full Name" required />
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="password" placeholder="Password" required />

      <div class="record-wakeword">
        <p class="record-title">Record voice recognition</p>
        <button id="recordBtn" type="button">
          <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" class="mic-icon" />
          Start Voice Recognition
        </button>
        <div id="record-status">not recording</div>
      </div>

      <button type="submit">Sign Up</button>
    </form>

    <p class="login-link">Already have an account? <a href="login.html">Login</a></p>
  </div>

  <div id="spinnerOverlay" class="spinner-overlay" style="display:none;">
    <img src="https://i.imgur.com/8KlT8jJ.png" alt="Luna Spinner" class="spinner-logo" />
  </div>

<script>
/* ---------------- CONFIG SECTION ---------------- */
const CLOUDINARY_CLOUD = "dm8xazeob";
const CLOUDINARY_PRESET = "luna_unsigned";
const ANALYSIS_SERVER = "https://luna-backend-rntz.onrender.com";
/* ------------------------------------------------- */

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDN4hgEwEZkL0gzEmlRWlabjAEt6fY3c88",
  authDomain: "luna-app-a3c50.firebaseapp.com",
  projectId: "luna-app-a3c50",
  storageBucket: "luna-app-a3c50.appspot.com",
  messagingSenderId: "683159311462",
  appId: "1:683159311462:web:2bef289d271172267d49a7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let mediaRecorder;
let audioChunks = [];
let voiceBlob;
let audioURL;
let transcriptText = "";
let detectedMood = "";

const wakeWords = ["sunshine", "galaxy", "luna", "starlight", "harmony"];
let currentWakeWord = "";

function speakLuna(text) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "en-US";
  speechSynthesis.speak(utter);
}

async function uploadAndAnalyzeVoice() {
  const status = document.getElementById("record-status");
  try {
    const formData = new FormData();
    formData.append("file", voiceBlob);
    formData.append("upload_preset", CLOUDINARY_PRESET);

    const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/raw/upload`;
    const upRes = await fetch(uploadUrl, { method: "POST", body: formData });
    const upJson = await upRes.json();
    if (!upRes.ok) {
      console.error("Cloudinary failed:", upJson);
      status.textContent = "Cloudinary upload failed";
      return;
    }
    audioURL = upJson.secure_url;
    status.textContent = "Uploaded. Analyzing mood...";

    const analyzeRes = await fetch(`${ANALYSIS_SERVER}/api/analyze_deepgram`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ audio_url: audioURL })
    });
    const analysis = await analyzeRes.json();
    detectedMood = analysis.mood || analysis.emotion || "neutral";
    status.textContent = `Detected mood: ${detectedMood}`;
    speakLuna("Voice recognition complete.");
    Toastify({
      text: `Voice recognition successful! Mood: ${detectedMood}`,
      duration: 3000,
      backgroundColor: "#4caf50"
    }).showToast();
  } catch (err) {
    console.error("upload/analysis error", err);
    status.textContent = "Upload or analysis failed";
  }
}

document.getElementById("recordBtn").addEventListener("click", async () => {
  const recordBtn = document.getElementById("recordBtn");
  const status = document.getElementById("record-status");

  if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
    alert("Speech recognition not supported in this browser.");
    return;
  }

  // Pick wake word
  currentWakeWord = wakeWords[Math.floor(Math.random() * wakeWords.length)];
  speakLuna(`Please say the word: ${currentWakeWord}`);
  status.textContent = `Luna says: "${currentWakeWord}" â€” Recording now...`;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    // Start speech recognition immediately
    const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
    const r = new Rec();
    r.lang = 'en-US';
    r.interimResults = false;
    r.maxAlternatives = 1;

    let recognizedText = "";
    r.onresult = (ev) => {
      recognizedText = ev.results[0][0].transcript.trim().toLowerCase();
      transcriptText = recognizedText;
    };

    r.start();
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      voiceBlob = new Blob(audioChunks, { type: "audio/webm" });
      r.stop();

      if (recognizedText === currentWakeWord.toLowerCase()) {
        status.textContent = "Correct word detected. Uploading...";
        await uploadAndAnalyzeVoice();
      } else {
        status.textContent = `Word mismatch! You said "${recognizedText}", expected "${currentWakeWord}"`;
        speakLuna("Voice recognition failed. Please try again.");
      }
    };

    mediaRecorder.start();
    recordBtn.disabled = true;

    setTimeout(() => {
      try { mediaRecorder.stop(); } catch (e) { console.warn(e); }
      recordBtn.disabled = false;
      recordBtn.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" class="mic-icon" /> Re-record Voice Sample`;
    }, 3000);

  } catch (err) {
    console.error(err);
    alert("Microphone access denied or not available.");
    status.textContent = "Recording failed";
  }
});
</script>
</body>
</html>
