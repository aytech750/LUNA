<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Luna - Sign Up</title>
  <link rel="stylesheet" href="signup.css"/>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"/>
</head>
<body class="signup-body">
  <div class="form-container">
    <img src="https://i.imgur.com/8KlT8jJ.png" alt="Luna Logo" class="logo" />
    <h1>Create Your Luna Account</h1>
    <form id="signupForm">
      <input type="text" id="name" placeholder="Full Name" required />
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="password" placeholder="Password" required />

      <div class="record-wakeword">
        <p class="record-title">Record voice recognition</p>
        <button type="button" id="recordBtn">
          <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" alt="Mic" class="mic-icon">
          <span>Start Recording</span>
        </button>
        <p class="record-status" id="record-status">Not recording</p>
      </div>

      <button type="submit">Sign Up</button>
    </form>

    <p class="login-link">Already have an account? <a href="login.html">Login</a></p>
  </div>

  <div id="spinnerOverlay" class="spinner-overlay" style="display:none;">
    <img src="https://i.imgur.com/8KlT8jJ.png" alt="Luna Spinner" class="spinner-logo" />
  </div>

<script>
/* ---------------- CONFIG SECTION - replace values before running ---------------- */
const CLOUDINARY_CLOUD = "dm8xazeob";    // your cloud name
const CLOUDINARY_PRESET = "luna_unsigned";// your unsigned preset
const ANALYSIS_SERVER = "http://localhost:3001"; // server URL (change if deployed)
/* ------------------------------------------------------------------------------- */

/* Firebase config - keep as you already have or replace with your project's config */
const firebaseConfig = {
  apiKey: "AIzaSyDN4hgEwEZkL0gzEmlRWlabjAEt6fY3c88",
  authDomain: "luna-app-a3c50.firebaseapp.com",
  projectId: "luna-app-a3c50",
  storageBucket: "luna-app-a3c50.appspot.com",
  messagingSenderId: "683159311462",
  appId: "1:683159311462:web:2bef289d271172267d49a7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* State */
let mediaRecorder, audioChunks = [], voiceBlob = null, audioURL = "", transcriptText = "";
let detectedMood = "neutral";

/* Utility: speak with mood adjustments */
function speakLuna(text, mood = "neutral") {
  const opts = { rate: 1.0, pitch: 0 };
  if (mood === "happy" || mood === "joy") { opts.rate = 1.25; opts.pitch = 2; }
  else if (mood === "angry") { opts.rate = 1.1; opts.pitch = 1; }
  else if (mood === "sad") { opts.rate = 0.9; opts.pitch = -2; }
  // pick a voice (best-effort)
  const voices = window.speechSynthesis.getVoices();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = opts.rate;
  u.pitch = opts.pitch;
  // prefer an English voice if available
  const pick = voices.find(v => v.lang && v.lang.startsWith('en')) || voices[0];
  if (pick) u.voice = pick;
  window.speechSynthesis.speak(u);
}

/* Recording + upload + server analysis flow */
document.getElementById("recordBtn").addEventListener("click", async () => {
  const recordBtn = document.getElementById("recordBtn");
  const status = document.getElementById("record-status");
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    // capture chunks
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    // on stop: build blob, upload to cloudinary, then call analysis server
    mediaRecorder.onstop = async () => {
      voiceBlob = new Blob(audioChunks, { type: "audio/webm" });
      status.textContent = "Uploading audio to Cloudinary...";
      try {
        const formData = new FormData();
        formData.append("file", voiceBlob);
        formData.append("upload_preset", CLOUDINARY_PRESET);

        const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/raw/upload`;
        const upRes = await fetch(uploadUrl, { method: "POST", body: formData });
        const upJson = await upRes.json();
        if (!upRes.ok) {
          console.error("Cloudinary failed:", upJson);
          status.textContent = "Cloudinary upload failed";
          return;
        }
        audioURL = upJson.secure_url;
        status.textContent = "Uploaded. Analyzing mood...";

        // Optional: quick local speech recognition (if available) to get a transcript
        try {
          if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
            const r = new Rec();
            r.lang = 'en-US';
            r.onresult = (ev) => { transcriptText = ev.results[0][0].transcript; };
            r.start();
            // stop after short delay (we already have audio; this is best-effort)
            setTimeout(()=>{ try{ r.stop(); }catch(e){} }, 1200);
          }
        } catch(e){ console.warn("local speech rec failed", e); }

        // Call your analysis server (Deepgram) to get mood/emotion
        const analyzeRes = await fetch(`${ANALYSIS_SERVER}/api/analyze_deepgram`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ audio_url: audioURL })
        });
        const analysis = await analyzeRes.json();
        // analysis shape depends on your server; we expect analysis.mood or analysis.emotion
        detectedMood = analysis.mood || analysis.emotion || "neutral";
        status.textContent = `Detected mood: ${detectedMood}`;
        speakLuna("Voice recognition SUCCESSFUL.");
        Toastify({ text: `Voice RECOGNITION SUCCESSFUL! Detected mood: ${detectedMood}`, duration: 3000, backgroundColor: "#4caf50" }).showToast();
      } catch (err) {
        console.error("upload/analysis error", err);
        status.textContent = "Upload or analysis failed";
      }
    };

    // start
    mediaRecorder.start();
    status.textContent = "Recording... speak now";
    recordBtn.disabled = true;

    // stop automatically after 4s
    setTimeout(() => {
      try { mediaRecorder.stop(); } catch (e) { console.warn(e); }
      recordBtn.disabled = false;
      recordBtn.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" class="mic-icon" /> Re-record Voice Sample`;
    }, 4000);

  } catch (err) {
    console.error(err);
    alert("Microphone access denied or not available.");
    document.getElementById("record-status").textContent = "Recording failed";
  }
});

/* Signup submit: ask user for gender (quick prompt), assign opposite-luna, save to Firestore */
document.getElementById("signupForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const spinner = document.getElementById("spinnerOverlay");
  const btn = document.querySelector("button[type='submit']");

  if (!voiceBlob || !audioURL) {
    Toastify({ text: "Please record your voice sample!", duration: 3000, backgroundColor: "#ffa000" }).showToast();
    return;
  }

  // quick prompt to get user's gender (keeps your HTML unchanged)
  let userGender = prompt("What's your gender? (male / female / other)", "other");
  if (userGender) userGender = userGender.toLowerCase();
  else userGender = "other";

  // assign opposite luna gender (female <-> male), default female for other
  let lunaVoice = (userGender === "male") ? "female" : (userGender === "female" ? "male" : "female");

  btn.disabled = true; spinner.style.display = "flex";

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const uid = userCredential.user.uid;

    // save to Firestore - include detectedMood from analysis
    await db.collection("users").doc(uid).set({
      name,
      email,
      gender: userGender,
      lunaVoice,
      detectedMood,
      voiceSampleURL: audioURL,
      voiceTranscript: transcriptText || "",
      createdAt: new Date()
    });

    speakLuna(`Welcome, ${name}. I will speak with a ${lunaVoice} voice.`, detectedMood);
    Toastify({ text: `Welcome, ${name}!`, duration: 3000, backgroundColor: "#2563eb" }).showToast();

    setTimeout(()=> window.location.href = "dashboard.html", 2000);
  } catch (err) {
    console.error(err);
    Toastify({ text: err.message || "Signup failed", duration: 3000, backgroundColor: "#d32f2f" }).showToast();
    btn.disabled = false; spinner.style.display = "none";
  }
});
</script>
</body>
</html>
